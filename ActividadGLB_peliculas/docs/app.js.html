<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file app.js
 * @description
 * Script de interfaz (UI) para la CMDB de películas.
 * Controla la interacción con el DOM para:
 *  - Gestión de géneros (alta, baja, modificación, consulta)
 *  - Gestión de películas (alta, baja, modificación, consulta)
 *  - Listado con votaciones
 *
 * Esta capa depende de CMDBLogic.js para la lógica y persistencia.
 *
 * @author
 * Miguel Garcia
 * @version 1.0.0
 */

/**
 * Ejecuta las inicializaciones necesarias según los elementos presentes en la página.
 * - Si existe CMDBLogic.ensureUnknownGenre, asegura el género base.
 * - Si hay formulario de géneros, inicializa esa vista.
 * - Si hay formulario de películas, inicializa CRUD de películas.
 * - Si hay tabla de películas sin formulario, inicializa listado.
 *
 * @listens DOMContentLoaded
 * @returns {void}
 */
document.addEventListener("DOMContentLoaded", () => {
  // si existe la lógica externa
  if (window.CMDBLogic?.ensureUnknownGenre) {
    CMDBLogic.ensureUnknownGenre();
  }

  if (document.getElementById("genreForm")) initGenresPage();
  if (document.getElementById("movieForm")) initMoviesPage();
  if (document.getElementById("moviesTable")) initListadoPage();
});

/* ============================ GÉNEROS ============================ */

/**
 * Inicializa la página de gestión de géneros:
 * - Listener del formulario (alta/modificación).
 * - Delegación de eventos en la tabla para editar/eliminar.
 * - Render inicial.
 *
 * @returns {void}
 */
function initGenresPage() {
  const form = document.getElementById("genreForm");
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    addOrUpdateGenre();
  });

  // Delegación de eventos para botones Editar/Eliminar
  const tableBody = document.getElementById("genresTable");
  tableBody.addEventListener("click", (e) => {
    const tr = e.target.closest("tr");
    if (!tr) return;

    const id = parseInt(tr.dataset.id);

    if (e.target.classList.contains("btn-edit-genre")) {
      startEditGenre(id);
    }

    if (e.target.classList.contains("btn-delete-genre")) {
      deleteGenre(id);
    }
  });

  listGenres();
}

/**
 * Añade un género nuevo o actualiza uno existente usando lógica externa.
 * Lee el nombre y el id en edición (si existe), delega en CMDBLogic
 * y refresca la vista.
 *
 * @returns {void}
 */
function addOrUpdateGenre() {
  const nameInput = document.getElementById("genreName");
  const idEditingInput = document.getElementById("genreIdEditing");

  const name = nameInput.value;
  const idEditing = idEditingInput.value
    ? parseInt(idEditingInput.value)
    : null;

  const res = CMDBLogic.addOrUpdateGenreLogic(name, idEditing);
  if (!res.ok) {
    alert(res.msg);
    return;
  }

  idEditingInput.value = "";
  nameInput.value = "";
  listGenres();
}

/**
 * Carga los datos de un género en el formulario
 * para iniciar el modo edición.
 *
 * @param {number} id - ID del género a editar.
 * @returns {void}
 */
function startEditGenre(id) {
  const genre = CMDBLogic.getGenres().find(g => g.id === id);
  if (!genre) return;

  document.getElementById("genreIdEditing").value = id;
  document.getElementById("genreName").value = genre.name;
}

/**
 * Elimina un género mediante CMDBLogic.deleteGenreLogic.
 * Si hay error (por ejemplo, usado por una película), lo muestra.
 *
 * @param {number} id - ID del género a eliminar.
 * @returns {void}
 */
function deleteGenre(id) {
  const res = CMDBLogic.deleteGenreLogic(id);
  if (!res.ok) {
    alert(res.msg);
    return;
  }
  listGenres();
}

/**
 * Renderiza la tabla de géneros en pantalla.
 * Después refresca el selector múltiple de géneros en películas.
 *
 * @returns {void}
 */
function listGenres() {
  const table = document.getElementById("genresTable");
  if (!table) return;

  const genres = CMDBLogic.getGenres();
  table.innerHTML = "";

  genres.forEach(g => {
    const tr = document.createElement("tr");
    tr.dataset.id = g.id;

    tr.innerHTML = `
      &lt;td>${g.id}&lt;/td>
      &lt;td>${g.name}&lt;/td>
      &lt;td>
        &lt;button type="button" class="btn-edit-genre">Editar&lt;/button>
        &lt;button type="button" class="btn-delete-genre">Eliminar&lt;/button>
      &lt;/td>
    `;
    table.appendChild(tr);
  });

  fillGenresSelect();
}

/* ============================ PELÍCULAS ============================ */

/**
 * Inicializa la página CRUD de películas:
 * - Rellena selector de géneros
 * - Render inicial de tabla
 * - Listeners de Guardar / Eliminar / Nueva
 * - Delegación para cargar peli al formulario al clicar fila
 *
 * @returns {void}
 */
function initMoviesPage() {
  fillGenresSelect();
  listMovies(false);

  document.getElementById("saveMovie")
    .addEventListener("click", saveOrUpdateMovie);

  document.getElementById("deleteMovie")
    .addEventListener("click", deleteMovie);

  document.getElementById("newMovie")
    .addEventListener("click", clearMovieForm);

  // Delegación de eventos para seleccionar fila en CRUD
  const tableBody = document.getElementById("moviesTable");
  tableBody.addEventListener("click", (e) => {
    const tr = e.target.closest("tr");
    if (!tr) return;

    // si estamos en CRUD (no en listado votar)
    if (!tableBody.dataset.mode || tableBody.dataset.mode !== "votes") {
      const movieId = parseInt(tr.dataset.id);
      const movie = CMDBLogic.getMovies().find(m => m.id === movieId);
      if (movie) loadMovieIntoForm(movie);
    }
  });
}

/**
 * Rellena el &lt;select multiple> con los géneros existentes.
 *
 * @returns {void}
 */
function fillGenresSelect() {
  const select = document.getElementById("movieGenres");
  if (!select) return;

  const genres = CMDBLogic.getGenres();
  select.innerHTML = "";

  genres.forEach(g => {
    const opt = document.createElement("option");
    opt.value = g.id;
    opt.textContent = g.name;
    select.appendChild(opt);
  });
}

/**
 * Guarda una película nueva o actualiza una existente.
 * Lee inputs del formulario, asigna género desconocido si no hay selección,
 * delega en CMDBLogic.saveOrUpdateMovieLogic y refresca tabla.
 *
 * @returns {void}
 */
function saveOrUpdateMovie() {
  const idStr = document.getElementById("movieId").value.trim();
  const title = document.getElementById("movieTitle").value.trim();
  const releaseDate = document.getElementById("movieReleaseDate").value;
  const popularity = parseFloat(document.getElementById("moviePopularity").value);

  let selectedGenres = Array.from(
    document.getElementById("movieGenres").selectedOptions
  ).map(o => parseInt(o.value));

  // si no seleccionan nada -> género desconocido
  if (selectedGenres.length === 0) {
    const unknown = CMDBLogic.getGenres()
      .find(g => g.name.toLowerCase() === "género desconocido");
    if (unknown) selectedGenres = [unknown.id];
  }

  const id = idStr ? parseInt(idStr) : null;

  const res = CMDBLogic.saveOrUpdateMovieLogic({
    id, title, releaseDate, popularity, genres: selectedGenres
  });

  if (!res.ok) {
    alert(res.msg);
    return;
  }

  clearMovieForm();
  listMovies(false);
}

/**
 * Elimina la película seleccionada en el formulario.
 * Delegado a CMDBLogic.deleteMovieLogic.
 *
 * @returns {void}
 */
function deleteMovie() {
  const idStr = document.getElementById("movieId").value.trim();
  if (!idStr) {
    alert("Selecciona una película primero.");
    return;
  }

  const id = parseInt(idStr);
  const res = CMDBLogic.deleteMovieLogic(id);

  if (!res.ok) {
    alert(res.msg);
    return;
  }

  clearMovieForm();
  listMovies(false);
}

/**
 * Limpia/reset del formulario de películas.
 *
 * @returns {void}
 */
function clearMovieForm() {
  document.getElementById("movieId").value = "";
  document.getElementById("movieTitle").value = "";
  document.getElementById("movieReleaseDate").value = "";
  document.getElementById("moviePopularity").value = "";
  document.getElementById("movieGenres").selectedIndex = -1;
}

/**
 * Carga una película desde la tabla al formulario CRUD.
 *
 * @param {Object} movie - Película a mostrar.
 * @param {number} movie.id - Identificador único.
 * @param {string} movie.title - Título.
 * @param {string} movie.releaseDate - Fecha estreno YYYY-MM-DD.
 * @param {number} movie.popularity - Popularidad 0..100.
 * @param {number[]} movie.genres - IDs de géneros.
 * @returns {void}
 */
function loadMovieIntoForm(movie) {
  document.getElementById("movieId").value = movie.id;
  document.getElementById("movieTitle").value = movie.title;
  document.getElementById("movieReleaseDate").value = movie.releaseDate || "";
  document.getElementById("moviePopularity").value = movie.popularity ?? "";

  const sel = document.getElementById("movieGenres");
  Array.from(sel.options).forEach(opt => {
    opt.selected = movie.genres.includes(parseInt(opt.value));
  });
}

/**
 * Dibuja la tabla de películas.
 * - withVotes=false: modo CRUD (sin botón votar)
 * - withVotes=true : modo listado con votación
 *
 * También marca table.dataset.mode para que initMoviesPage sepa si debe
 * cargar filas al formulario.
 *
 * @param {boolean} [withVotes=false] - Si true se activa la columna votar.
 * @returns {void}
 */
function listMovies(withVotes = false) {
  const table = document.getElementById("moviesTable");
  if (!table) return;

  const movies = CMDBLogic.getMovies();
  const genres = CMDBLogic.getGenres();
  table.innerHTML = "";

  // marca modo para saber si es listado votar
  table.dataset.mode = withVotes ? "votes" : "crud";

  movies.forEach(movie => {
    const movieGenres = movie.genres
      .map(gid => genres.find(g => g.id === gid)?.name)
      .filter(Boolean)
      .join(", ");

    const tr = document.createElement("tr");
    tr.dataset.id = movie.id;

    if (withVotes) {
      tr.innerHTML = `
        &lt;td>${movie.id}&lt;/td>
        &lt;td>${movie.title}&lt;/td>
        &lt;td>${movie.releaseDate || "-"}&lt;/td>
        &lt;td>${movie.popularity ?? "-"}&lt;/td>
        &lt;td>${movie.score || "0.00"}&lt;/td>
        &lt;td>${movie.votes || 0}&lt;/td>
        &lt;td>${movieGenres || "-"}&lt;/td>
        &lt;td>
          &lt;input type="number" min="1" max="10" step="1" id="rating-${movie.id}">
          &lt;button type="button" class="btn-rate-movie">Votar&lt;/button>
        &lt;/td>
      `;
    } else {
      tr.innerHTML = `
        &lt;td>${movie.id}&lt;/td>
        &lt;td>${movie.title}&lt;/td>
        &lt;td>${movie.releaseDate || "-"}&lt;/td>
        &lt;td>${movie.popularity ?? "-"}&lt;/td>
        &lt;td>${movieGenres || "-"}&lt;/td>
      `;
    }

    table.appendChild(tr);
  });
}

/* ============================ LISTADO (VOTAR) ============================ */

/**
 * Inicializa la vista de listado:
 * - Delegación de evento para votar
 * - Render inicial
 *
 * @returns {void}
 */
function initListadoPage() {
  const tableBody = document.getElementById("moviesTable");

  // Delegación para botón votar
  tableBody.addEventListener("click", (e) => {
    if (!e.target.classList.contains("btn-rate-movie")) return;

    const tr = e.target.closest("tr");
    if (!tr) return;

    const id = parseInt(tr.dataset.id);
    rateMovie(id);
  });

  listMovies(true);
}

/**
 * Envía una valoración a la lógica y refresca la tabla.
 *
 * @param {number} id - ID de la película a votar.
 * @returns {void}
 */
function rateMovie(id) {
  const input = document.getElementById(`rating-${id}`);
  const rating = parseInt(input.value);

  const res = CMDBLogic.rateMovieLogic(id, rating);
  if (!res.ok) {
    alert(res.msg);
    return;
  }

  listMovies(true);
  input.value = "";
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#GENRES_KEY">GENRES_KEY</a></li><li><a href="global.html#MOVIES_KEY">MOVIES_KEY</a></li><li><a href="global.html#OLD_GENRES_KEY">OLD_GENRES_KEY</a></li><li><a href="global.html#OLD_MOVIES_KEY">OLD_MOVIES_KEY</a></li><li><a href="global.html#addOrUpdateGenre">addOrUpdateGenre</a></li><li><a href="global.html#addOrUpdateGenreLogic">addOrUpdateGenreLogic</a></li><li><a href="global.html#clearMovieForm">clearMovieForm</a></li><li><a href="global.html#deleteGenre">deleteGenre</a></li><li><a href="global.html#deleteGenreLogic">deleteGenreLogic</a></li><li><a href="global.html#deleteMovie">deleteMovie</a></li><li><a href="global.html#deleteMovieLogic">deleteMovieLogic</a></li><li><a href="global.html#ensureUnknownGenre">ensureUnknownGenre</a></li><li><a href="global.html#fillGenresSelect">fillGenresSelect</a></li><li><a href="global.html#getGenres">getGenres</a></li><li><a href="global.html#getMovies">getMovies</a></li><li><a href="global.html#initGenresPage">initGenresPage</a></li><li><a href="global.html#initListadoPage">initListadoPage</a></li><li><a href="global.html#initMoviesPage">initMoviesPage</a></li><li><a href="global.html#listGenres">listGenres</a></li><li><a href="global.html#listMovies">listMovies</a></li><li><a href="global.html#loadMovieIntoForm">loadMovieIntoForm</a></li><li><a href="global.html#migrateOldKeysIfNeeded">migrateOldKeysIfNeeded</a></li><li><a href="global.html#rateMovie">rateMovie</a></li><li><a href="global.html#rateMovieLogic">rateMovieLogic</a></li><li><a href="global.html#saveGenres">saveGenres</a></li><li><a href="global.html#saveMovies">saveMovies</a></li><li><a href="global.html#saveOrUpdateMovie">saveOrUpdateMovie</a></li><li><a href="global.html#saveOrUpdateMovieLogic">saveOrUpdateMovieLogic</a></li><li><a href="global.html#startEditGenre">startEditGenre</a></li><li><a href="global.html#validateMovieInput">validateMovieInput</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Fri Dec 05 2025 10:41:57 GMT+0100 (hora estándar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
